"use strict";angular.module("angularTalk",[]).directive("angularTalk",["$http","$timeout","windowStatus",function(e,n,s){return{restrict:"AC",scope:{settings:"="},templateUrl:"angularTalk/room.html",link:function(t,i,a){function o(e){if(e.id){if(l(e.id))return;e.id>p&&(p=e.id),(e.id<m||angular.isUndefined(m))&&(m=e.id)}e.$replies=[],e.replyToID?u[e.id]=e:t.messages.push(e);do{var n=0;angular.forEach(u,function(e,s){var t=l(e.replyToID);t&&(t.$replies.push(e),delete u[s],n++)})}while(n>0);t.$emit("messageReceived",e)}function r(e,n,s){return e.indexOf("?")>=0?"&"!==e.substring(0,e.length-1)&&(e+="&"):e+="?",e+=encodeURIComponent(n)+"="+encodeURIComponent(s)}function l(e,n){var s=!1;return angular.forEach(n||t.messages,function(n){n.id&&n.id==e&&(s=n),!s&&n.$replies&&(s=l(e,n.$replies))}),s}function d(n,i){t.loading=!0,e.get(g.ajaxEndpoint,{params:angular.extend({since:m,dir:"DESC",count:25},n)}).then(function(e){e.data&&(angular.forEach(e.data.data,o),e.data.data.length>0&&f&&s.hidden&&f.play(),i&&i(e.data)),t.loading=!1},function(){t.loading=!1,i&&i(!1)})}function c(){g.updateInterval&&n(function(){d({},c)},g.updateInterval)}var g=t.settings;if(!g.ajaxEndpoint)throw new Error("Invalid ajax endpoint");t.messages=[],t.message={};var u={};t.save=function(n){n.isSending=!0,n.isError=!1,n.isEditing=!1;var s={};angular.forEach(n,function(e,n){"$"!=n[0]&&0!==n.indexOf("is")&&(s[n]=e)}),e[n.id?"put":"post"](g.ajaxEndpoint,s).then(function(e){n.isSending=!1,e.data&&(n.isError=!1,angular.extend(n,e.data.data),t.$emit("messageSend",n))},function(){n.isSending=!1,n.isError=!0}),t.content=""},t.submit=function(){if(t.message.content){var e=angular.extend(t.message,{author:g.sender,date:new Date/1e3|0});o(e),t.save(e),t.message={}}},t.current={},t.messageKeyPress=function(e){return g.submitOnEnter&&13==e.keyCode?(t.submit(),e.preventDefault(),!1):void(27==e.keyCode&&(t.cancelEdit(t.current.message),t.current.message=null))},t.reply=function(e){e.$replies.push({author:g.sender,isEditing:!0,content:"",date:new Date/1e3|0,replyToID:e.id})},t.edit=function(e){e.isEditing=!0,e.originalContent=e.content},t.cancelEdit=function(e){e.isEditing=!1,e.content=e.originalContent,e.id||t.delete(e)},t.delete=function(n){function s(){function e(n,s){var t=s.indexOf(n);t>=0&&s.splice(t,1),angular.forEach(s,function(s){s.$replies&&e(n,s.$replies)})}e(n,t.messages)}n.id?confirm(g.strings.delete_confirm)&&e.delete(r(g.ajaxEndpoint,"id",n.id)).then(s):s()},t.previousMessage=function(e){var n=void 0;return angular.forEach(t.messages,function(s){s.replyToID==e.replyToID&&s.id!=e.id&&s.date<=e.date&&(!n||n.date<s.date)&&(n=s)}),n};var m,p=0,f=null;g.soundOnNew&&(angular.isString(g.soundOnNew)?f=new Audio(g.soundOnNew):(f=document.createElement("audio"),angular.forEach(g.soundOnNew,function(e,n){var s=document.createElement("source");s.type=n,s.src=e,f.appendChild(s)}))),t.loadingOlder=!1,t.disableOlder=!1,t.onScroll=function(e){t.disableOlder||0!=e||(t.loadingOlder=!0,d({since:m,dir:"DESC"},function(e){0==e.data.length&&(t.disableOlder=!0),t.loadingOlder=!1}))},d({},c),t.$on("$destroy",function(){g.updateInterval=!1})}}}]).directive("angularTalkScroll",function(){return{priority:1,scope:{onScroll:"&"},restrict:"A",link:function(e,n){function s(){i.scrollTop=i.scrollHeight}function t(){return i.scrollTop+i.clientHeight+1>=i.scrollHeight}var i=n[0],a=!0;e.$watch(function(){a&&s()}),n.bind("scroll",function(){a=t(),e.onScroll({offset:i.scrollTop})})}}}).directive("init",function(){return{priority:0,compile:function(){return{pre:function(e,n,s){e.$eval(s.init)}}}}}).service("windowStatus",function(){function e(e){var t={focus:!0,focusin:!0,pageshow:!0,blur:!1,focusout:!1,pagehide:!1};e=e||window.event,e.type in t?n.visible=t[e.type]:n.visible=this[s]?!1:!0,n.hidden=!n.visible}var n={visible:!0,hidden:!1},s="hidden";return s in document?document.addEventListener("visibilitychange",e):(s="mozHidden")in document?document.addEventListener("mozvisibilitychange",e):(s="webkitHidden")in document?document.addEventListener("webkitvisibilitychange",e):(s="msHidden")in document?document.addEventListener("msvisibilitychange",e):"onfocusin"in document?document.onfocusin=document.onfocusout=e:window.onpageshow=window.onpagehide=window.onfocus=window.onblur=e,void 0!==document[s]&&e({type:document[s]?"blur":"focus"}),n}).run(["windowStatus",function(){}]),angular.module("angularTalk").run(["$templateCache",function(e){e.put("angularTalk/messages.html",'<div\nng-repeat-start="message in messages | orderBy:\'+date\' track by message.id || $id(message)"\nclass="moment"\nng-show="settings.groupMessages && ($index==0 || (message.date - previousMessage(message).date)>30000)">\n<time\nclass="relative" datetime="{{ ::message.date*1000 | date:\'yyyy-MM-dd HH:mm:ss Z\' }}">{{ ::message.date*1000 | date:\'medium\' }}</time></div><div\nng-repeat-end class="message" ng-class="{\n\'from-sender\': message.author.id==settings.sender.id,\nreversed:settings.reverseSenderMessages && message.author.id==settings.sender.id,\nactive:message.isActive,\nerror:message.isError}" ng-click="message.isActive=!message.isActive">\n<a\nng-show="settings.showFaces" class="message-img" ng-href="{{::message.author.url}}" title="{{::message.author.name}}">\n<img\nng-src="{{::message.author.icon}}" alt="{{::message.author.name}}">\n</a><div\nclass="message-wrapper"><div\nclass="message-body" title="{{ ::message.date*1000 | date:\'medium\' }}"><div\nng-hide="message.isEditing">\n{{ message.content }}<div\nclass="message-info" ng-show="!settings.groupMessages || message.isActive || message.isSending || message.isError">\n<span\nng-show="message.isError">\n<a\nclass="retry-send" ng-click="save(message)">\n<i\nclass="icon icon-warning fa fa-warning"></i>\n{{ ::settings.strings.retrySend }}\n</a>\n<span\nclass="bullet">•</span>\n</span>\n<span\nng-show="message.isSending">\n<span\nclass="loader icon icon-circle-o-notch icon-spin fa fa-circle-o-notch fa-spin"></span>\n<span\nclass="bullet">•</span>\n</span>\n<span\nng-show="::settings.showUserName">\n<a\nclass="author" ng-href="{{ ::message.author.url }}">\n{{ ::message.author.name }}\n</a>\n<span\nclass="bullet">•</span>\n</span>\n<span\nng-show="::replyLevel < settings.replyLevels-1 && settings.allowReplies && message.id && !settings.readOnly">\n<a\nclass="reply" ng-click="reply(message)">\n<i\nclass="icon icon-reply fa fa-reply"></i>\n<span\nclass="text-info">{{ ::settings.strings.reply }}</span>\n</a>\n<span\nclass="bullet">•</span>\n</span>\n<span\nng-show="::settings.sender.isModerator || message.author.id == settings.sender.id">\n<a\nclass="edit" ng-click="edit(message)">\n<i\nclass="icon icon-edit fa fa-edit"></i>\n<span\nclass="text-info">{{ ::settings.strings.edit }}</span>\n</a>\n<span\nclass="bullet">•</span>\n<a\nclass="delete" ng-click="delete(message)">\n<i\nclass="icon icon-remove fa fa-remove"></i>\n<span\nclass="text-info">{{ ::settings.strings.delete }}</span>\n</a>\n<span\nclass="bullet">•</span>\n</span>\n<time\nclass="relative" datetime="{{::message.date*1000 | date:\'yyyy-MM-dd HH:mm:ss Z\'}}">{{::message.date*1000 | date:\'medium\'}}</time></div></div><div\nng-if="message.isEditing"><textarea ng-model="message.content"\n                       ng-keyup="messageKeyPress($event)"\n                       ng-focus="current.message = message"\n                       placeholder="{{ ::settings.strings.messagePlaceholder }}"></textarea><div\nclass="tools">\n<a\nng-click="cancelEdit(message)">{{ ::settings.strings.cancel }}</a><button\ntype="button" class="submit" ng-click="save(message)" ng-disabled="!message.content">\n{{ message.id ? settings.strings.save : settings.strings.submit }}\n</button></div></div></div>\n<ng-include\nng-if="message.$replies.length>0 && settings.allowReplies && replyLevel < settings.replyLevels-1"\nsrc="\'angularTalk/messages.html\'"\ninit="messages = message.$replies; replyLevel = replyLevel+1"></ng-include></div></div>'),e.put("angularTalk/room.html",'<div\nclass="messages" angular-talk-scroll ng-class="{faces:settings.showFaces}" on-scroll="onScroll(offset)"><div\nclass="main-loader" ng-show="loadingOlder">\n<span\nclass="loader icon icon-circle-o-notch icon-spin fa fa-circle-o-notch fa-spin"></span></div><div\nclass="empty-room" ng-show="messages.length==0">{{ ::settings.strings.emptyRoom }}</div>\n<ng-include\nsrc="\'angularTalk/messages.html\'" init="messages = messages; replyLevel = 0"></ng-include></div><div\nclass="footer" ng-if="!settings.readOnly"><textarea ng-model="message.content"\n              ng-keyup="messageKeyPress($event)"\n              rows="3" cols="1"\n              placeholder="{{ ::settings.strings.messagePlaceholder }}"></textarea><div\nstyle="text-align: right">\n<button\ntype="button" class="submit" ng-click="submit(message)" ng-disabled="!message.content">\n{{message.id ? settings.strings.save : settings.strings.submit}}\n</button></div></div>')}]);